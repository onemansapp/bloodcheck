<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡€åœ§è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            touch-action: manipulation;
        }
        .app {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background: white;
        }
        .screen {
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-top: 60px;
        }
        .top-buttons {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 600px;
            display: flex;
            gap: 8px;
            padding: 16px;
            background: white;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        button:active {
            transform: scale(0.95);
        }
        .btn-primary {
            background: #4A6A7E;
            color: white;
            flex: 1;
        }
        .btn-secondary {
            background: #4A6A7E;
            color: white;
            flex: 1;
        }
        .btn-danger {
            background: #E53935;
            color: white;
        }
        .btn-success {
            background: #6B7C8A;
            color: white;
        }
        .btn-clear {
            background: #E53935;
            color: white;
        }
        .btn-home {
            background: #6B7C8A;
            color: white;
        }
        .btn-history {
            background: #4A6A7E;
            color: white;
        }
        .user-btn {
            width: 100%;
            height: 80px;
            font-size: 24px;
            margin: 12px 0;
        }
        input {
            width: 100%;
            padding: 16px;
            font-size: 32px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 12px 0;
        }
        .time-buttons {
            display: flex;
            gap: 8px;
            margin: 20px 0;
        }
        .time-btn {
            flex: 1;
            height: 56px;
            font-size: 32px;
        }
        .calendar {
            margin: 20px 0;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            aspect-ratio: 1;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            background: white;
        }
        .calendar-day.has-record {
            background: #E3F2FD;
            font-weight: bold;
        }
        .calendar-day.empty:hover {
            background: #f5f5f5;
        }
        .record-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 12px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .record-values {
            display: flex;
            justify-content: space-around;
            margin-top: 8px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .hidden {
            display: none !important;
        }
        h2 {
            margin-bottom: 16px;
        }
        .add-button-container {
            text-align: center;
            margin-top: 20px;
            padding-bottom: 20px;
        }
        .add-button {
            background: #2196F3;
            color: white;
            padding: 16px 48px;
            font-size: 20px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .date-picker {
            text-align: center;
        }
        .date-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 16px 0;
            gap: 16px;
        }
        .date-selector button {
            padding: 8px 16px;
            font-size: 18px;
        }
        .date-selector span {
            font-size: 20px;
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }
        .selected-date-display {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠç”»é¢ -->
        <div id="userScreen" class="screen">
            <h2 style="text-align: center; margin-top: 100px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</h2>
            <button class="user-btn btn-primary" onclick="selectUser('A')">ãƒ¦ãƒ¼ã‚¶ãƒ¼ A</button>
            <button class="user-btn btn-primary" onclick="selectUser('B')">ãƒ¦ãƒ¼ã‚¶ãƒ¼ B</button>
            <button class="user-btn btn-primary" onclick="selectUser('C')">ãƒ¦ãƒ¼ã‚¶ãƒ¼ C</button>
        </div>

        <!-- å…¥åŠ›ç”»é¢ -->
        <div id="inputScreen" class="screen hidden">
            <div class="top-buttons">
                <button class="btn-clear" style="flex: 1;" onclick="clearInput()">ã‚¯ãƒªã‚¢</button>
                <button class="btn-home" style="flex: 1;" onclick="goHome()">ğŸ </button>
                <button class="btn-history" style="flex: 1;" onclick="showHistory()">ğŸ“Š</button>
            </div>
            <div class="header">
               <!-- <h2>è¡€åœ§ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2> -->
            </div>
            <input type="number" id="systolic" placeholder="æœ€é«˜è¡€åœ§" maxlength="3">
            <input type="number" id="diastolic" placeholder="æœ€ä½è¡€åœ§" maxlength="3">
            <input type="number" id="pulse" placeholder="è„ˆæ‹" maxlength="3">
        </div>

        <!-- æ™‚é–“å¸¯é¸æŠç”»é¢ -->
        <div id="timeScreen" class="screen hidden">
            <div class="top-buttons">
                <button class="btn-home" style="flex: 1;" onclick="goHome()">ğŸ </button>
                <button class="btn-history" style="flex: 1;" onclick="showHistory()">ğŸ“Š</button>
            </div>
            <div class="header">
                <h2>æ¸¬å®šæ™‚é–“å¸¯ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            </div>
            <div class="time-buttons">
                <button class="time-btn btn-primary" onclick="saveRecord('æœ')">ğŸŒ…</button>
                <button class="time-btn btn-primary" onclick="saveRecord('æ˜¼')">ğŸŒ</button>
                <button class="time-btn btn-primary" onclick="saveRecord('å¤œ')">ğŸŒ™</button>
            </div>
        </div>

        <!-- å±¥æ­´ç”»é¢ -->
        <div id="historyScreen" class="screen hidden">
            <div class="top-buttons">
                <button class="btn-primary" style="flex: 1;" onclick="exportCSV()">ğŸ“‹</button>
                <button class="btn-home" style="flex: 1;" onclick="goHome()">ğŸ </button>
                <button class="btn-history" style="flex: 1;" onclick="toggleCalendar()">ğŸ“…</button>
            </div>
            <div class="header">
                <h2 id="historyTitle">å±¥æ­´</h2>
            </div>
            <div id="listView"></div>
            <div id="calendarView" class="hidden"></div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let currentUser = '';
        let currentScreen = 'user';
        let selectedDate = null;
        let showingCalendar = false;
        let pickerYear = new Date().getFullYear();
        let pickerMonth = new Date().getMonth();
        let pickerDay = new Date().getDate();
        let calendarYear = new Date().getFullYear();
        let calendarMonth = new Date().getMonth();

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        function getRecords() {
            return JSON.parse(localStorage.getItem('bloodPressureRecords') || '[]');
        }

        function saveRecords(records) {
            localStorage.setItem('bloodPressureRecords', JSON.stringify(records));
        }

        function getUserRecords(user) {
            return getRecords().filter(r => r.user === user);
        }

        // ç”»é¢é·ç§»
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screen + 'Screen').classList.remove('hidden');
            currentScreen = screen;
        }

        function selectUser(user) {
            currentUser = user;
            showScreen('input');
            document.getElementById('systolic').focus();
        }

        function goHome() {
            selectedDate = null;
            showScreen('user');
        }

        function clearInput() {
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
            document.getElementById('pulse').value = '';
            document.getElementById('systolic').focus();
        }

        // å…¥åŠ›å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            const systolic = document.getElementById('systolic');
            const diastolic = document.getElementById('diastolic');
            const pulse = document.getElementById('pulse');

            systolic.addEventListener('input', (e) => {
                if (e.target.value.length >= getMaxLength(e.target.value[0])) {
                    diastolic.focus();
                }
            });

            diastolic.addEventListener('input', (e) => {
                if (e.target.value.length >= getMaxLength(e.target.value[0])) {
                    pulse.focus();
                }
            });

            pulse.addEventListener('input', (e) => {
                if (e.target.value.length >= getMaxLength(e.target.value[0])) {
                    if (systolic.value && diastolic.value) {
                        showScreen('time');
                    }
                }
            });
        });

        function getMaxLength(firstDigit) {
            return parseInt(firstDigit) >= 4 ? 2 : 3;
        }

        function saveRecord(timeOfDay) {
            const sys = document.getElementById('systolic').value;
            const dia = document.getElementById('diastolic').value;
            const pul = document.getElementById('pulse').value;

            if (!sys || !dia || !pul) return;

            const records = getRecords();
            const date = selectedDate || new Date().toISOString();
            
            records.push({
                user: currentUser,
                systolic: parseInt(sys),
                diastolic: parseInt(dia),
                pulse: parseInt(pul),
                timeOfDay: timeOfDay,
                date: date
            });

            saveRecords(records);
            clearInput();
            selectedDate = null;
            showHistory();
        }

        // å±¥æ­´è¡¨ç¤º
        function showHistory() {
            showScreen('history');
            document.getElementById('historyTitle').textContent = `å±¥æ­´ (ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser})`;
            showingCalendar = false;
            renderList();
        }

        function renderList() {
            const records = getUserRecords(currentUser).sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            const html = records.length === 0 
                ? '<p style="text-align: center; margin-top: 50px;">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</p>'
                : records.map(r => `
                    <div class="record-card" onclick="editRecord('${r.date}')">
                        <div>${new Date(r.date).toLocaleString('ja-JP')}</div>
                        <div class="record-values">
                            <div><small>æœ€é«˜è¡€åœ§</small><br><strong>${r.systolic}</strong></div>
                            <div><small>æœ€ä½è¡€åœ§</small><br><strong>${r.diastolic}</strong></div>
                            <div><small>è„ˆæ‹</small><br><strong>${r.pulse}</strong></div>
                            <div style="font-size: 32px;">${r.timeOfDay === 'æœ' ? 'ğŸŒ…' : r.timeOfDay === 'æ˜¼' ? 'ğŸŒ' : 'ğŸŒ™'}</div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('listView').innerHTML = html;
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('calendarView').classList.add('hidden');
        }

        function toggleCalendar() {
            showingCalendar = !showingCalendar;
            if (showingCalendar) {
                calendarYear = new Date().getFullYear();
                calendarMonth = new Date().getMonth();
                renderCalendar();
                document.getElementById('listView').classList.add('hidden');
                document.getElementById('calendarView').classList.remove('hidden');
            } else {
                renderList();
            }
        }

        function changeCalendarMonth(delta) {
            calendarMonth += delta;
            if (calendarMonth > 11) {
                calendarMonth = 0;
                calendarYear++;
            } else if (calendarMonth < 0) {
                calendarMonth = 11;
                calendarYear--;
            }
            renderCalendar();
        }

        function renderCalendar() {
            const year = calendarYear;
            const month = calendarMonth;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const records = getUserRecords(currentUser);
            const recordsByDate = {};
            records.forEach(r => {
                const date = new Date(r.date).toISOString().split('T')[0];
                if (!recordsByDate[date]) recordsByDate[date] = [];
                recordsByDate[date].push(r);
            });

            let html = `
                <div class="calendar">
                    <div class="calendar-header">
                        <button class="btn-primary" onclick="changeCalendarMonth(-1)">â—€</button>
                        <h3>${year}å¹´${month + 1}æœˆ</h3>
                        <button class="btn-primary" onclick="changeCalendarMonth(1)">â–¶</button>
                    </div>
                    <div class="calendar-grid">
                        <div style="text-align: center; font-weight: bold;">æ—¥</div>
                        <div style="text-align: center; font-weight: bold;">æœˆ</div>
                        <div style="text-align: center; font-weight: bold;">ç«</div>
                        <div style="text-align: center; font-weight: bold;">æ°´</div>
                        <div style="text-align: center; font-weight: bold;">æœ¨</div>
                        <div style="text-align: center; font-weight: bold;">é‡‘</div>
                        <div style="text-align: center; font-weight: bold;">åœŸ</div>
            `;

            for (let i = 0; i < firstDay; i++) {
                html += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const dayRecords = recordsByDate[dateStr] || [];
                const hasRecord = dayRecords.length > 0;

                html += `
                    <div class="calendar-day ${hasRecord ? 'has-record' : 'empty'}" 
                         onclick="selectCalendarDay('${dateStr}', ${JSON.stringify(dayRecords).replace(/"/g, '&quot;')})">
                        <div>${day}</div>
                        ${hasRecord ? `<div style="font-size: 10px;">Ã—${dayRecords.length}</div>` : ''}
                    </div>
                `;
            }

            html += `
                </div>
                <div class="add-button-container">
                    <button class="add-button" onclick="showDatePicker()">â• è¿½åŠ </button>
                </div>
                </div>
            `;
            document.getElementById('calendarView').innerHTML = html;
        }

        function selectCalendarDay(dateStr, records) {
            if (records.length > 0) {
                showDayRecords(records);
            } else {
                selectedDate = new Date(dateStr + 'T12:00:00').toISOString();
                showScreen('input');
                clearInput();
            }
        }

        function showDayRecords(records) {
            const html = `
                <h3>${new Date(records[0].date).toLocaleDateString('ja-JP')} ã®è¨˜éŒ²</h3>
                ${records.map(r => `
                    <div class="record-card" onclick="editRecord('${r.date}')">
                        <div>${r.timeOfDay === 'æœ' ? 'ğŸŒ… æœ' : r.timeOfDay === 'æ˜¼' ? 'ğŸŒ æ˜¼' : 'ğŸŒ™ å¤œ'}</div>
                        <div class="record-values">
                            <div><small>æœ€é«˜</small><br><strong>${r.systolic}</strong></div>
                            <div>/</div>
                            <div><small>æœ€ä½</small><br><strong>${r.diastolic}</strong></div>
                            <div><small>è„ˆæ‹</small><br><strong>${r.pulse}</strong></div>
                        </div>
                    </div>
                `).join('')}
                <button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="closeModal()">é–‰ã˜ã‚‹</button>
            `;
            showModal(html);
        }

        function editRecord(date) {
            const records = getRecords();
            const record = records.find(r => r.date === date);
            if (!record) return;

            const html = `
                <h3>è¨˜éŒ²ã‚’ç·¨é›†</h3>
                <input type="number" id="editSys" value="${record.systolic}" placeholder="æœ€é«˜è¡€åœ§">
                <input type="number" id="editDia" value="${record.diastolic}" placeholder="æœ€ä½è¡€åœ§">
                <input type="number" id="editPul" value="${record.pulse}" placeholder="è„ˆæ‹">
                <div class="time-buttons">
                    <button class="time-btn ${record.timeOfDay === 'æœ' ? 'btn-primary' : 'btn-secondary'}" onclick="setEditTime('æœ')">ğŸŒ…</button>
                    <button class="time-btn ${record.timeOfDay === 'æ˜¼' ? 'btn-primary' : 'btn-secondary'}" onclick="setEditTime('æ˜¼')">ğŸŒ</button>
                    <button class="time-btn ${record.timeOfDay === 'å¤œ' ? 'btn-primary' : 'btn-secondary'}" onclick="setEditTime('å¤œ')">ğŸŒ™</button>
                </div>
                <button class="btn-danger" style="width: 100%; margin: 16px 0;" onclick="deleteRecord('${date}')">ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤</button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-primary" style="flex: 1;" onclick="updateRecord('${date}')">ä¿å­˜</button>
                    <button class="btn-secondary" style="flex: 1;" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;
            showModal(html);
            window.editingTime = record.timeOfDay;
        }

        function setEditTime(time) {
            window.editingTime = time;
            editRecord(document.querySelector('.modal-content input').dataset.date || new Date().toISOString());
        }

        function updateRecord(oldDate) {
            const records = getRecords();
            const index = records.findIndex(r => r.date === oldDate);
            if (index === -1) return;

            records[index] = {
                ...records[index],
                systolic: parseInt(document.getElementById('editSys').value),
                diastolic: parseInt(document.getElementById('editDia').value),
                pulse: parseInt(document.getElementById('editPul').value),
                timeOfDay: window.editingTime
            };

            saveRecords(records);
            closeModal();
            showHistory();
        }

        function deleteRecord(date) {
            if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const records = getRecords().filter(r => r.date !== date);
            saveRecords(records);
            closeModal();
            showHistory();
        }

        function exportCSV() {
            const records = getUserRecords(currentUser).sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );

            let csv = 'æ—¥ä»˜,æœ€é«˜è¡€åœ§,æœ€ä½è¡€åœ§,è„ˆæ‹,æ¸¬å®šæ™‚é–“å¸¯\n';
            records.forEach(r => {
                csv += `${new Date(r.date).toLocaleString('ja-JP')},${r.systolic},${r.diastolic},${r.pulse},${r.timeOfDay}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `blood_pressure_${currentUser}_${Date.now()}.csv`;
            link.click();
        }

        function showModal(html) {
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal(event) {
            if (!event || event.target.id === 'modal') {
                document.getElementById('modal').classList.remove('show');
            }
        }

        function showDatePicker() {
            const now = new Date();
            pickerYear = now.getFullYear();
            pickerMonth = now.getMonth();
            pickerDay = now.getDate();
            updateDatePickerDisplay();
        }

        function updateDatePickerDisplay() {
            const html = `
                <div class="date-picker">
                    <h3>æ—¥ä»˜ã‚’é¸æŠ</h3>
                    
                    <div class="date-selector">
                        <button class="btn-primary" onclick="changeYear(-1)">â—€</button>
                        <span>${pickerYear}å¹´</span>
                        <button class="btn-primary" onclick="changeYear(1)">â–¶</button>
                    </div>

                    <div class="date-selector">
                        <button class="btn-primary" onclick="changeMonth(-1)">â—€</button>
                        <span>${pickerMonth + 1}æœˆ</span>
                        <button class="btn-primary" onclick="changeMonth(1)">â–¶</button>
                    </div>

                    <div class="date-selector">
                        <button class="btn-primary" onclick="changeDay(-1)">â—€</button>
                        <span>${pickerDay}æ—¥</span>
                        <button class="btn-primary" onclick="changeDay(1)">â–¶</button>
                    </div>

                    <div class="selected-date-display">
                        ${pickerYear}å¹´${pickerMonth + 1}æœˆ${pickerDay}æ—¥
                    </div>

                    <div style="display: flex; gap: 8px; margin-top: 20px;">
                        <button class="btn-primary" style="flex: 1;" onclick="confirmDateSelection()">OK</button>
                        <button class="btn-secondary" style="flex: 1;" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
            `;
            showModal(html);
        }

        function changeYear(delta) {
            pickerYear += delta;
            updateDatePickerDisplay();
        }

        function changeMonth(delta) {
            pickerMonth += delta;
            if (pickerMonth > 11) {
                pickerMonth = 0;
                pickerYear++;
            } else if (pickerMonth < 0) {
                pickerMonth = 11;
                pickerYear--;
            }
            // æ—¥ä»˜ã®èª¿æ•´
            const maxDay = new Date(pickerYear, pickerMonth + 1, 0).getDate();
            if (pickerDay > maxDay) pickerDay = maxDay;
            updateDatePickerDisplay();
        }

        function changeDay(delta) {
            pickerDay += delta;
            const maxDay = new Date(pickerYear, pickerMonth + 1, 0).getDate();
            if (pickerDay > maxDay) {
                pickerDay = 1;
                changeMonth(1);
            } else if (pickerDay < 1) {
                changeMonth(-1);
                pickerDay = new Date(pickerYear, pickerMonth + 1, 0).getDate();
            } else {
                updateDatePickerDisplay();
            }
        }

        function confirmDateSelection() {
            const date = new Date(pickerYear, pickerMonth, pickerDay, 12, 0, 0);
            selectedDate = date.toISOString();
            closeModal();
            showScreen('input');
            clearInput();
        }
    </script>
</body>
</html>


